<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.8.3"><!-- Canonical URL --><link rel="canonical" href="https://borolgs.github.io/blog/effector-intro/"><!-- Primary Meta Tags --><title>Introduction to Effector</title><meta name="title" content="Introduction to Effector"><meta name="description" content="Introduction to Effector"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://borolgs.github.io/blog/effector-intro/"><meta property="og:title" content="Introduction to Effector"><meta property="og:description" content="Introduction to Effector"><!-- <meta property="og:image" content={new URL(image, Astro.url)} /> --><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://borolgs.github.io/blog/effector-intro/"><meta property="twitter:title" content="Introduction to Effector"><meta property="twitter:description" content="Introduction to Effector"><!-- <meta property="twitter:image" content={new URL(image, Astro.url)} /> --><link rel="stylesheet" href="/_astro/_slug_.Cm1_-nVk.css"><script type="module">new URLSearchParams(window.location.search).has("s")&&document.querySelector("header")?.remove();
</script></head> <body> <header class="container"> <nav aria-label="breadcrumb" hx-boost="true"> <ul> <li> <a href="/">Blog</a> </li> <li> <a href="/{slug}" aria-current="page"> Introduction to Effector </a> </li> </ul> </nav> </header> <main class="container"> <section> <h1 id="introduction-to-effector">Introduction to Effector</h1>
<blockquote>
<p>[!info] Write business logic with ease
Type safe, reactive, framework agnostic.</p>
</blockquote>
<p><a href="https://effector.dev/">https://effector.dev/</a><br>
<a href="https://effector.dev/en/introduction/motivation/">https://effector.dev/en/introduction/motivation/</a></p>
<p>Effector Представляет собой набор инструментов для работы с состоянием, событиями и связями между ними. Состоит из <strong>юнитов</strong> (реактивные примитивы) и <strong>операторов</strong> (методы для композиции и организации потока данных между юнитами).</p>
<h3 id="units">Units</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">// событие</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNote</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;{</span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">}>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// стор</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $notes</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">NotesDict</span><span style="color:#E1E4E8">>({});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// эффект: обертка для сайд-эффектов (как thunk в redux)</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNoteFx</span><span style="color:#E1E4E8">(async (args</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">}) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	return </span><span style="color:#B392F0">fetch</span><span style="color:#E1E4E8">(...);</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<p>Они называются юнитами, потому что несмотря на разное предназначение и особенности у них много общего.
Каждый юнит может быть как источником события, так тем кто на событие реагирует.</p>
<h3 id="model">Model</h3>
<p>Моделью мы будем называть совокупность <strong>юнитов</strong> и их <strong>связей</strong> между друг другом.
Вся бизнес-логика приложения, все процессы живут в моделях, связанных друг другом так же как связаны юниты внутри конкретной модели (фичи или модуля).</p>
<p>Модель это “вещь в себе” и принципиально ничего не знает о UI.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#6A737D">// model.ts</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNote</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> }>();</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $notes</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">NotesDict</span><span style="color:#E1E4E8">>({});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">$notes.</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(createNote, (</span><span style="color:#FFAB70">notes</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">note</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({ </span><span style="color:#F97583">...</span><span style="color:#E1E4E8">notes, [</span><span style="color:#B392F0">randomUUID</span><span style="color:#E1E4E8">()]: note }));</span></span>
<span class="line"></span></code></pre>
<p>А все что делает UI - это вызывает события модели и подписывается на сторы с помощью специальных хуков (в реакте).</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#6A737D">// add-note.tsx</span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">button</span><span style="color:#B392F0"> onClick</span><span style="color:#FDAEB7;font-style:italic">=(()</span><span style="color:#FDAEB7;font-style:italic"> =></span><span style="color:#FDAEB7;font-style:italic"> createNote({</span><span style="color:#B392F0"> text</span><span style="color:#FDAEB7;font-style:italic"> })))>Add&#x3C;/button></span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// notes-list.tsx</span></span>
<span class="line"><span style="color:#B392F0">const</span><span style="color:#B392F0"> notes</span><span style="color:#FDAEB7;font-style:italic"> =</span><span style="color:#FDAEB7;font-style:italic"> useStoreMap($notes,</span><span style="color:#B392F0"> notes</span><span style="color:#FDAEB7;font-style:italic"> =></span><span style="color:#FDAEB7;font-style:italic"> Object.entries(notes));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FDAEB7;font-style:italic">&#x3C;ul>{</span></span>
<span class="line"><span style="color:#FDAEB7;font-style:italic">  notes.map(([id,</span><span style="color:#E1E4E8"> {text}</span><span style="color:#FDAEB7;font-style:italic">])</span><span style="color:#FDAEB7;font-style:italic"> =></span><span style="color:#FDAEB7;font-style:italic"> (&#x3C;li</span><span style="color:#B392F0"> key</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{id}>...&#x3C;/</span><span style="color:#85E89D">li</span><span style="color:#E1E4E8">>)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span><span style="color:#F97583">&#x3C;/</span><span style="color:#E1E4E8">ul</span><span style="color:#F97583">></span></span>
<span class="line"></span></code></pre>
<p><strong>REPL: <a href="https://share.effector.dev/HE3o5yNa">https://share.effector.dev/HE3o5yNa</a></strong></p>
<h3 id="methods-vs-operators">Methods vs Operators</h3>
<p>У юнитов есть методы, как <code>.on()</code> для подписки у стора из примера выше.<br>
Часть из этих методов общие для всех юнитов: <code>.map()</code>, <code>.filter()</code> <code>.watch()</code>,<code> .prepend()</code>.<br>
Какие-то уникальные, например <code>.use()</code> у эффекта.</p>
<p>Но так же у эффектора есть операторы, с помощью которых мы можем связывать юниты и описывать логику <em>ДеКлАрАтиВнО</em> 🌈.</p>
<h3 id="sample">Sample</h3>
<p>Основной оператор эффектора.</p>
<p><code>sample</code> - ключевой метод эффектора для создания связей и управления потоком событий.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">// model.ts</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNote</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> }>();</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $notes</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">NotesDict</span><span style="color:#E1E4E8">>({});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//$notes.on(createNote, (notes, note) => ({...notes, [randomUUID()]: note }));</span></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: createNote, </span><span style="color:#6A737D">// clock == on</span></span>
<span class="line"><span style="color:#E1E4E8">  source: $notes,</span></span>
<span class="line"><span style="color:#B392F0">  filter</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">notes</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">note</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> note.text </span><span style="color:#F97583">!==</span><span style="color:#9ECBFF"> ''</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// NEW</span></span>
<span class="line"><span style="color:#B392F0">  fn</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">notes</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">note</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">notes, [</span><span style="color:#B392F0">randomUUID</span><span style="color:#E1E4E8">()]: note })),</span></span>
<span class="line"><span style="color:#E1E4E8">  target: $notes,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">debug</span><span style="color:#E1E4E8">($notes) </span><span style="color:#6A737D">// {} -> { guid: {text: "hello"} }</span></span>
<span class="line"></span></code></pre>
<p>Может показать что стало хуже, но <em>это не так</em>.
Например, с <code>.on()</code> мы ограничены тем, что <code>target == source == $notes</code>, а <code>sample</code> развязывает нам руки.</p>
<p>Добавим сайд-эффект.<br>
Выполнение http-запроса, только после успешного выполнения которого, мы обновим $notes:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">// model.ts</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNote</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> }>();</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $notes</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">NotesDict</span><span style="color:#E1E4E8">>({});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNoteFx</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEffect</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">args</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> { </span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: createNote,</span></span>
<span class="line"><span style="color:#B392F0">  filter</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">notes</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">note</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> note.text </span><span style="color:#F97583">!==</span><span style="color:#9ECBFF"> ''</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  target: createNoteFx,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: createNoteFx.doneData,</span></span>
<span class="line"><span style="color:#E1E4E8">  source: $notes,</span></span>
<span class="line"><span style="color:#B392F0">  fn</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">notes</span><span style="color:#E1E4E8">, { </span><span style="color:#FFAB70">id</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">text</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">notes, [id]: note }),</span></span>
<span class="line"><span style="color:#E1E4E8">  target: $notes</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<p><strong>REPL: <a href="https://share.effector.dev/n5NJdZ0f">https://share.effector.dev/n5NJdZ0f</a></strong></p>
<p>Добавим показ нотификации на случай если произошла ошибка.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">// notes/model.ts</span></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: createNoteFx.failData,</span></span>
<span class="line"><span style="color:#B392F0">  fn</span><span style="color:#E1E4E8">: ({ </span><span style="color:#FFAB70">message</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({ type: </span><span style="color:#9ECBFF">'error'</span><span style="color:#E1E4E8">, message }),</span></span>
<span class="line"><span style="color:#E1E4E8">  target: addNotification,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// notifications/model.ts</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> addNotification</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;{</span></span>
<span class="line"><span style="color:#FFAB70">  type</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'error'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'warn'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'info'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  message</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'string'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8"> }>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> addNotificationFx</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEffect</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">) </span><span style="color:#6A737D">// call some notification library</span></span>
<span class="line"></span></code></pre>
<p>Добавим отправку ошибки в centry.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#6A737D">// notes/model.ts</span></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: createNoteFx.failData,</span></span>
<span class="line"><span style="color:#B392F0">  fn</span><span style="color:#E1E4E8">: ({ </span><span style="color:#FFAB70">message</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({ type: </span><span style="color:#9ECBFF">'error'</span><span style="color:#E1E4E8">, message }),</span></span>
<span class="line"><span style="color:#E1E4E8">  target: addNotification,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: createNoteFx.failData,</span></span>
<span class="line"><span style="color:#B392F0">  filter</span><span style="color:#E1E4E8">: ({ </span><span style="color:#FFAB70">status</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> status </span><span style="color:#F97583">>=</span><span style="color:#79B8FF"> 500</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">  fn</span><span style="color:#E1E4E8">: ({ </span><span style="color:#FFAB70">message</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">status</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({ message, </span><span style="color:#F97583">...</span><span style="color:#E1E4E8"> }),</span></span>
<span class="line"><span style="color:#E1E4E8">  target: centryError</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<p><code>sample</code> позволяет дробить логику на cлабосвязанные части, как в рамках конкретной модели, так и для всего приложения в целом.</p>
<p>При правильной организации приложения, добавление новой фичи превращается в точечное переписывание или добавление новых семплов.</p>
<h3 id="ui-model">UI Model</h3>
<p>Представим что в форме создания заметки несколько полей.
Значение для каждого поля живет в своем сторе и при отправке запроса, данные берутся из этих сторов:</p>
<p>Предполагается что сторы делаются максимально атомарными, тк зачастую оказывается что это банально удобнее.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#6A737D">// features/add-note/model.ts</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> addNote</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> updateTitle</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> addTag</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">>();</span></span>
<span class="line"><span style="color:#F97583">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $title</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(updateTitle, (</span><span style="color:#FFAB70">_</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">title</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> title);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $text</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">""</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> $tags</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createStore</span><span style="color:#E1E4E8">([]);</span></span>
<span class="line"><span style="color:#F97583">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  clock: addNote,</span></span>
<span class="line"><span style="color:#E1E4E8">  source: { title: $title, text: $text, tags: $tags },</span></span>
<span class="line"><span style="color:#B392F0">  filter</span><span style="color:#E1E4E8">: ({ </span><span style="color:#FFAB70">title</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">text</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> [title, text].</span><span style="color:#B392F0">every</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">v</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> v </span><span style="color:#F97583">!==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> v </span><span style="color:#F97583">!==</span><span style="color:#9ECBFF"> ''</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">  target: createNote,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// features/add-note/ui.tsx</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">title</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">text</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> useUnit</span><span style="color:#E1E4E8">([$title, $text]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">input</span><span style="color:#B392F0"> value</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{title} </span><span style="color:#B392F0">onChange</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#FFAB70">e</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> updateTitle</span><span style="color:#E1E4E8">(e.target.value)} /></span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">input</span><span style="color:#B392F0"> value</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{text} </span><span style="color:#FDAEB7;font-style:italic">...</span><span style="color:#E1E4E8"> /></span></span>
<span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">button</span><span style="color:#B392F0"> onClick</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{(() </span><span style="color:#F97583">=></span><span style="color:#B392F0"> addNote</span><span style="color:#E1E4E8">())}>Save&#x3C;/</span><span style="color:#85E89D">button</span><span style="color:#E1E4E8">></span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// entity/notes/model.ts</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> createNote</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> createEvent</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">title</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">text</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">tags</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[] }>();</span></span>
<span class="line"><span style="color:#F97583">...</span></span>
<span class="line"></span></code></pre>
<p>В примере выше прям сильно сократил, см. REPL.</p>
<p><strong>REPL: <a href="https://share.effector.dev/h9SV9NHB">https://share.effector.dev/h9SV9NHB</a></strong></p>
<h3 id="other-operators">Other operators</h3>
<p><code>sample</code> невероятно гибкий и может быть представлен во всевозможных комбинациях:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#B392F0">sample</span><span style="color:#E1E4E8">({ source?, clock?, filter?, fn?, target? }): target</span></span>
<span class="line"></span></code></pre>
<ul>
<li>clock может не быть, тогда source вместо него.</li>
<li>clock, source и target могут быть списками юнитов.</li>
<li>source может быть объектом из юнитов.</li>
<li>filter может быть как функцией так и стором</li>
<li>если нет target, то sample возвращает новый юнит. это может быть как событие так и стор.</li>
</ul>
<p>Все комбинации и типы возвращаемых значений перечислены документации.<br>
Естественно все комбинации прикрыты TS’ом и у всего работает вывод типов.</p>
<p>У эффектора есть еще несколько операторов входящих в core: <code>combine</code>, <code>merge</code>, <code>split</code>, <code>attach</code>.<br>
И более расширенный набор в отдельной библиотеке <a href="https://patronum.effector.dev/methods">patronum</a>: <code>debug</code>, <code>debounce</code>, <code>spread</code>, <code>every</code> и пр.
Но всех их можно рассматривать как алиасы над sample (условно).</p>
<p>Одна из идей при разработке эффектора была не превращаться в rxjs, поэтому кол-во операторов принципиально не большое, а некоторые даже будут убраны из следующей версии.</p>
<h3 id="testing">Testing</h3>
<p>Комфорт разработки и уверенность в результате нам дают юнит-тесты.<br>
Написание которых относится к ключевым фишкам эффектора.</p>
<p>За это отвечает <a href="https://effector.dev/en/api/effector/fork/">Fork API</a>.</p>
<p><code>fork()</code> - создает изолированную копию всего приложения (все юниты и связи),
с возможностью подменять эффекты и значения сторов.<br>
А <code>allSettled(effect, opts)</code> - гарантирует что все вычисления после вызова события или эффекта будут завершены.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"add note - success"</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> scope</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> fork</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">   handlers: [</span></span>
<span class="line"><span style="color:#E1E4E8">     [createNoteFx, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> ({ id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, text: </span><span style="color:#9ECBFF">"todo"</span><span style="color:#E1E4E8"> })]</span></span>
<span class="line"><span style="color:#E1E4E8">   ]</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  await</span><span style="color:#B392F0"> allSettled</span><span style="color:#E1E4E8">(addNote, { scope, params: { text: </span><span style="color:#9ECBFF">"todo"</span><span style="color:#E1E4E8"> } });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  expect</span><span style="color:#E1E4E8">(scope.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">($notes)).</span><span style="color:#B392F0">toMatchObject</span><span style="color:#E1E4E8">({</span><span style="color:#9ECBFF">"1"</span><span style="color:#E1E4E8">: {text: </span><span style="color:#9ECBFF">"todo"</span><span style="color:#E1E4E8"> }});</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"add note - fail"</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> addNotificationFxMock</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> jest.</span><span style="color:#B392F0">fn</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> scope</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> fork</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">   handlers: [</span></span>
<span class="line"><span style="color:#E1E4E8">     [createNoteFx, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> throw </span><span style="color:#F97583">new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'oops'</span><span style="color:#E1E4E8">)],</span></span>
<span class="line"><span style="color:#E1E4E8">     [addNotificationFx, addNotificationFxMock]</span></span>
<span class="line"><span style="color:#E1E4E8">   ]</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  await</span><span style="color:#B392F0"> allSettled</span><span style="color:#E1E4E8">(addNote, { scope, params: { text: </span><span style="color:#9ECBFF">"todo"</span><span style="color:#E1E4E8"> } });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  expect</span><span style="color:#E1E4E8">(scope.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">($notes)).</span><span style="color:#B392F0">toMatchObject</span><span style="color:#E1E4E8">({});</span></span>
<span class="line"><span style="color:#B392F0">  expect</span><span style="color:#E1E4E8">(addNotificationFxMock).</span><span style="color:#B392F0">toBeCalledTimes</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3 id="сonclusion">Сonclusion</h3>
<p>Многое осталось за скобками: другие операторы и их композиция, производные юниты(derived), фабрики, библиотеки и экосистема.</p>
<p>Но того что мы узнали достаточно для веселого старта:</p>
<ul>
<li>юниты <a href="https://effector.dev/en/api/effector/event/"><code>event</code></a>, <a href="https://effector.dev/en/api/effector/store/"><code>store</code></a> и <a href="https://effector.dev/en/api/effector/effect/"><code>effect</code></a></li>
<li>оператор <a href="https://effector.dev/en/api/effector/sample/"><code>sample</code></a></li>
<li>реакт-хуки <a href="https://effector.dev/en/api/effector-react/useunit/"><code>useUnit</code></a> и <a href="https://effector.dev/en/api/effector-react/usestoremap/"><code>useStoreMap</code></a></li>
<li>не используем <code>.watch()</code> <del>для логики</del>, вообще его не используем, см. <a href="https://patronum.effector.dev/methods/debug/"><code>debug</code></a></li>
<li>помним что все юниты и связи должны быть объявлены статически (не в компонентах!)</li>
</ul>
<p>Итого, основная идея эффектора в следующем:
Cобытия и сторы представляют собой контракт, на основе которого выстраиваются отношения между моделями и UI, а вся логика содержится в легко “разрываемых” и свободно переписываемых операторах.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="mermaid"><code><span class="line"><span style="color:#E1E4E8">flowchart LR</span></span>
<span class="line"><span style="color:#E1E4E8">	$notes</span></span>
<span class="line"><span style="color:#E1E4E8">	createNote["createNote()"]</span></span>
<span class="line"><span style="color:#E1E4E8">	createNoteFx["createNoteFx()"]</span></span>
<span class="line"><span style="color:#E1E4E8">	addNote["addNote()"]</span></span>
<span class="line"><span style="color:#E1E4E8">	addNoteSample{sample}</span></span>
<span class="line"><span style="color:#E1E4E8">	createNoteSample{sample}</span></span>
<span class="line"><span style="color:#E1E4E8">	syncNoteSample{sample}</span></span>
<span class="line"><span style="color:#E1E4E8">	addNotification["addNotification()"]</span></span>
<span class="line"><span style="color:#E1E4E8">	error["error()"]</span></span>
<span class="line"><span style="color:#E1E4E8">	createNoteReq["POST /api/notes"]</span></span>
<span class="line"><span style="color:#E1E4E8">	%%updateNoteReq["PUT /api/notes"]</span></span>
<span class="line"><span style="color:#E1E4E8">	%%getNotesReq["GET /api/notes"]</span></span>
<span class="line"><span style="color:#E1E4E8">	$title</span></span>
<span class="line"><span style="color:#E1E4E8">	$text</span></span>
<span class="line"><span style="color:#E1E4E8">	$fields</span></span>
<span class="line"><span style="color:#E1E4E8">	button["&#x3C; button />"]</span></span>
<span class="line"><span style="color:#E1E4E8">	titleInput["&#x3C; input />"]</span></span>
<span class="line"><span style="color:#E1E4E8">	textInput["&#x3C; input />"]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	notesList["&#x3C; ul />"]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	classDef i fill:#2a9d8f,color: white</span></span>
<span class="line"><span style="color:#E1E4E8">	classDef m fill:#e76f51,color: white</span></span>
<span class="line"><span style="color:#E1E4E8">	classDef p fill:#264653,color: white</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    style Model fill:#edede9</span></span>
<span class="line"><span style="color:#E1E4E8">    style UI fill:#edede9</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	subgraph Model</span></span>
<span class="line"><span style="color:#E1E4E8">		subgraph notes/model.ts</span></span>
<span class="line"><span style="color:#E1E4E8">		    createNote:::i</span></span>
<span class="line"><span style="color:#E1E4E8">		    createNoteFx:::p</span></span>
<span class="line"><span style="color:#E1E4E8">	        createNoteSample:::m</span></span>
<span class="line"><span style="color:#E1E4E8">	        syncNoteSample:::m</span></span>
<span class="line"><span style="color:#E1E4E8">		    $notes:::i</span></span>
<span class="line"><span style="color:#E1E4E8">	    end</span></span>
<span class="line"><span style="color:#E1E4E8">		subgraph sahred/api.ts</span></span>
<span class="line"><span style="color:#E1E4E8">		createNoteFx ---> createNoteReq</span></span>
<span class="line"><span style="color:#E1E4E8">	end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	    subgraph notifications/model.ts</span></span>
<span class="line"><span style="color:#E1E4E8">		    syncNoteSample ---> addNotification:::i</span></span>
<span class="line"><span style="color:#E1E4E8">	    end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	    subgraph centry.ts</span></span>
<span class="line"><span style="color:#E1E4E8">		    createNoteSample ---> error:::i</span></span>
<span class="line"><span style="color:#E1E4E8">	    end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	    subgraph add-note/model.ts</span></span>
<span class="line"><span style="color:#E1E4E8">		    addNote:::i --clock--> addNoteSample</span></span>
<span class="line"><span style="color:#E1E4E8">		    $title:::i --combine--> $fields</span></span>
<span class="line"><span style="color:#E1E4E8">		    $text:::i --combine--> $fields</span></span>
<span class="line"><span style="color:#E1E4E8">		    $fields --source--> addNoteSample</span></span>
<span class="line"><span style="color:#E1E4E8">		    addNoteSample:::m --target--> createNote</span></span>
<span class="line"><span style="color:#E1E4E8">	    end</span></span>
<span class="line"><span style="color:#E1E4E8">    end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    subgraph UI</span></span>
<span class="line"><span style="color:#E1E4E8">        subgraph AddNote.tsx</span></span>
<span class="line"><span style="color:#E1E4E8">		    button</span></span>
<span class="line"><span style="color:#E1E4E8">		    titleInput</span></span>
<span class="line"><span style="color:#E1E4E8">		    textInput</span></span>
<span class="line"><span style="color:#E1E4E8">		end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		subgraph NoteList.tsx</span></span>
<span class="line"><span style="color:#E1E4E8">			notesList</span></span>
<span class="line"><span style="color:#E1E4E8">		end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	    button --> addNote</span></span>
<span class="line"><span style="color:#E1E4E8">	    titleInput --← useUnit--- $title</span></span>
<span class="line"><span style="color:#E1E4E8">	    textInput --← useUnit--- $text</span></span>
<span class="line"><span style="color:#E1E4E8">	    notesList --← useStoreMap--- $notes</span></span>
<span class="line"><span style="color:#E1E4E8">    end</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<h3 id="references">References</h3>
<p>Экосистема</p>
<ul>
<li><a href="https://effector.dev/en/introduction/ecosystem/">https://effector.dev/en/introduction/ecosystem/</a></li>
<li><a href="https://patronum.effector.dev/methods">https://patronum.effector.dev/methods</a> - Библиотека дополнительных операторов</li>
<li><a href="https://farfetched.pages.dev/">https://farfetched.pages.dev/</a> - Типа RTK/React Query</li>
<li><a href="https://atomic-router.github.io/">https://atomic-router.github.io/</a> - Роутер</li>
</ul>
<p>Статьи</p>
<ul>
<li><a href="https://effector.dev/en/guides/testing/">https://effector.dev/en/guides/testing/</a></li>
<li><a href="https://effector.dev/en/guides/server-side-rendering/">https://effector.dev/en/guides/server-side-rendering/</a></li>
<li><a href="https://withease.pages.dev/magazine/">https://withease.pages.dev/magazine/</a></li>
<li><a href="https://withease.pages.dev/magazine/migration_from_redux">https://withease.pages.dev/magazine/migration_from_redux</a></li>
</ul> </section> </main> <footer class="container"></footer> </body></html>